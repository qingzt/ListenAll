name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: windows-latest

    permissions:
      contents: write   # å¯¹ä»“åº“å†…å®¹çš„è¯»å†™æƒé™
      discussions: write

    steps:
    - name: Checkout Repository
      uses: actions/checkout@main

    - name: Set up Flutter
      uses: subosito/flutter-action@main
      with:
        channel: 'stable'
        cache: true
        # optional parameters follow
        cache-key: "flutter-:os:-:channel:-:version:-:arch:-:hash:" # optional, change this to force refresh cache
        cache-path: "${{ runner.tool_cache }}/flutter/:channel:-:version:-:arch:" # optional, change this to specify the cache path
        pub-cache-key: "flutter-pub:os:-:channel:-:version:-:arch:-:hash:" # optional, change this to force refresh cache of dart pub get dependencies
        pub-cache-path: "${{ runner.tool_cache }}/flutter/:channel:-:version:-:arch:" # optional, change this to specify the cache path

    - name: Install dependencies
      run: flutter pub get

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin' # See 'Supported distributions' for available options
        java-version: '17'

    - name: Build Apk
      run: flutter build apk --split-per-abi

    - name : After Apk Build
      run: ..\..\..\..\after_apk_build.bat
      working-directory: build\app\outputs\flutter-apk

    - name: Build Desktop
      run: flutter build windows  # æˆ–è€…ä½¿ç”¨å…¶ä»–å¹³å°çš„å‘½ä»¤ï¼Œä¾‹å¦‚ flutter build macos æˆ– flutter build linux

    - name: After Windows Build
      run:  ..\..\..\..\..\after_windows_build.bat
      working-directory: build\windows\x64\runner\Release\
    
    - name: Install Node.js
      uses: actions/setup-node@main
      with:
        node-version: '14'
  
    - name: Install dependencies
      run: npm install -g bestzip

    - name: Create desktop ZIP file
      run: bestzip ..\..\..\..\..\listenall-x86-64-windows.zip *
      working-directory: build\windows\x64\runner\Release\

    - name: Build Changelog
      id: github_release
      uses: mikepenz/release-changelog-builder-action@v4
      with: 
        commitMode: true
        configurationJson: |
            {
              "template": "#{{CHANGELOG}}\n\n<details>\n<summary>Uncategorized</summary>\n\n#{{UNCATEGORIZED}}\n</details>",
              "categories": [
                {
                    "title": "## ğŸš€ Features",
                    "labels": ["feat", "feature", "enhancement"]
                },
                {
                    "title": "## ğŸ› Fixes",
                    "labels": ["fix", "bug"]
                },
                {
                    "title": "## ğŸ§ª Tests",
                    "labels": ["test"]
                },
                {
                    "title": "## ğŸ“¦ Dependencies",
                    "labels": ["dependencies"]
                }
                {
                    "title": "## ğŸ’¬ Other",
                    "labels": ["other"]
                },
              ],
              "label_extractor": [
                {
                  "pattern": "^(build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test){1}(\\([\\w\\-\\.]+\\))?(!)?: ([\\w ])+([\\s\\S]*)",
                  "target": "$1"
                }
              ],
            }

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@master
      with:
        tag_name: ${{ github.ref_name }}
        name: ListenAll ${{ github.ref_name }}
        body: ${{steps.github_release.outputs.changelog}}
        draft: false
        prerelease: false
        generate_release_notes: true
        make_latest: true
        files: |
          build/app/outputs/flutter-apk/listenall-armeabi-v7a-android.apk
          build/app/outputs/flutter-apk/listenall-arm64-v8a-android.apk
          build/app/outputs/flutter-apk/listenall-x86_64-android.apk
          listenall-x86-64-windows.zip
